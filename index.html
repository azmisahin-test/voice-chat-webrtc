<!DOCTYPE html>
<html>

<head>
    <title>Voice Chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <h1>Voice Chat</h1>
    <audio id="remoteAudio" autoplay></audio>
    <button id="callButton">Start a Conversation</button>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDhgqq7aq0j60NhGRDQGkgnvC1uuyMorVU",
            authDomain: "voice-chat-797eb.firebaseapp.com",
            projectId: "voice-chat-797eb",
            databaseURL: "https://voice-chat-797eb-default-rtdb.firebaseio.com/",
            storageBucket: "voice-chat-797eb.appspot.com",
            messagingSenderId: "815348752880",
            appId: "1:815348752880:web:a9e7243ea63e419c7dfd35",
            measurementId: "G-GBT9F23WEL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const callButton = document.getElementById("callButton");
        const remoteAudio = document.getElementById("remoteAudio");
        let localStream;
        let peerConnection;
        let isCaller = false;

        const servers = {
            iceServers: [
                {
                    urls: "stun:stun.l.google.com:19302",
                },
            ],
        };

        const handleIceCandidateEvent = async (event) => {
            if (event.candidate) {
                push(ref(database, 'candidates'), event.candidate.toJSON());
            }
        };

        const handleTrackEvent = (event) => {
            remoteAudio.srcObject = event.streams[0];
        };

        const addIceCandidates = (peerConnection) => {
            onChildAdded(ref(database, 'candidates'), async (snapshot) => {
                const candidate = new RTCIceCandidate(snapshot.val());
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(candidate);
                }
            });
        };

        callButton.onclick = async () => {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            peerConnection = new RTCPeerConnection(servers);

            peerConnection.onicecandidate = handleIceCandidateEvent;
            peerConnection.ontrack = handleTrackEvent;

            localStream.getTracks().forEach((track) => {
                peerConnection.addTrack(track, localStream);
            });

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            const offerRef = push(ref(database, 'offers'));
            set(offerRef, { sdp: offer.sdp, type: offer.type });

            isCaller = true;

            // Remove offer from Firebase when disconnected
            offerRef.onDisconnect(() => {
                remove(offerRef);
            });

            onChildAdded(ref(database, 'answers'), async (snapshot) => {
                const answer = snapshot.val();
                if (answer && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(
                        new RTCSessionDescription(answer)
                    );
                }
            });

            addIceCandidates(peerConnection);
        };

        onChildAdded(ref(database, 'offers'), async (snapshot) => {
            const offer = snapshot.val();
            if (!isCaller && offer) {
                peerConnection = new RTCPeerConnection(servers);
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                peerConnection.onicecandidate = handleIceCandidateEvent;
                peerConnection.ontrack = handleTrackEvent;

                localStream.getTracks().forEach((track) => {
                    peerConnection.addTrack(track, localStream);
                });

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                set(push(ref(database, 'answers')), { sdp: answer.sdp, type: answer.type });

                addIceCandidates(peerConnection);
            }
        });
    </script>
</body>

</html>